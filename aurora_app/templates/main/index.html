{% extends 'layout.html' %}

{% block title %}Welcome{% endblock %}

{% block nav %}
  <div class="navbar">
    <div class="navbar-inner">
      <a class="brand" href="{{ url_for('main.index') }}">Aurora</a>

      <ul class="nav">
        <li><a href="{{ url_for('projects.all') }}">Projects</a></li>
        <li><a href="{{ url_for('stages.all') }}">Stages</a></li>
        <li><a href="{{ url_for('tasks.all') }}">Tasks</a></li>
        <li><a href="{{ url_for('users.all') }}">Users</a></li>
      </ul>

      <ul class="nav pull-right">
        <li><a href="{{ url_for('users.view', id=g.user.id) }}"><i class="icon-user"></i> <strong>{{ g.user.username }}</strong></a></li>
        <li><a href="{{ url_for('notifications.all') }}"><i class="icon-exclamation-sign"></i> Notifications</a></li>
        <li><a href="{{ url_for('main.settings') }}"><i class="icon-wrench"></i> Personal settings</a></li>
        <li><a href="{{ url_for('main.logout') }}">Logout</a></li>
      </ul>
    </div>
  </div>
{% endblock %}

{% block body %}
  <div class='container-fluid'>
    <div class="span3 sidebar center">
      <ul class='nav nav-list well'>
        {% if projects %}
          {% for project in projects %}
            <li>
              <a href="{{ url_for('projects.view', id=project.id) }}"><strong>{{ project.name }}</strong></a>
              {% if project.stages %}
                <ul>
                  {% for stage in project.stages %}
                    <li><a href="{{ url_for('stages.view', id=stage.id) }}">{{ stage.name }}</a></li>
                  {% endfor %}
                </ul>
              {% else %}
                <ul>
                  {% if g.user.can('create_stage') %}
                    <li><a href="{{ url_for('stages.create', project_id=project.id) }}">New stage</a></li>
                  {% endif %}
                </ul>
              {% endif %}
            </li>

            {% if not loop.last %}
              <li class="divider"></li>
            {% endif %}
          {% endfor %}
        {% else %}
          {% if g.user.can('create_project') %}
            <li><a href="{{ url_for('projects.create') }}"><strong>New project</strong></a></li>
          {% endif %}
        {% endif %}
      </ul>
    </div>
    <div class="span10">
      {% block notifications %}
        <div id='notifications'>
          <ul class='unstyled'>
          </ul>
        </div>
      {% endblock %}

      {% block content %}
        {% if not deployments %}
          <h4 class='alert'>
            No available deployments.
          </h4>
        {% else %}
          <ul class='unstyled inline view-title'>
            <li><h1>Last deployments</h1></li>
          </ul>

          <hr />

          <ul class='unstyled'>
            {% for deployment in deployments %}
              <li>{% include 'deployments/deployment.html' %}</li>
            {% endfor %}
          </ul>
        {% endif %}
      {% endblock %}
    </div>
  </div>
{% endblock %}

{% block js %}
  <script src="{{ url_for('static', filename='mustache/mustache.js') }}"></script>
  <script src="{{ url_for('static', filename='eventsource/eventsource.js') }}"></script>
  <script>
    $(function () {
      /* Hooks */
      $("#cancel_deployment_button").click(function() {
        var id = $(this).data('id');
        $.ajax({
          url: '{{ url_for('deployments.cancel') }}',
          type: 'POST',
          data: {'id': id}
        });
      });

      /* Notifications settings */
      var notification_template = '<li>\
        <div class="alert alert-{{ '{{category}}' }}">\
          <button type="button" class="close" data-dismiss="alert">&times;</button>\
          {{ '{{message}}' }}\
        </div>\
      </li>';
      var desktop_notifications_allowed = notify.permissionLevel() == notify.PERMISSION_GRANTED;
      var notification_timeout = 4000;

      var eventSource = new EventSource("{{ url_for('notifications.unseen') }}");
      eventSource.onmessage = function(e) {
        var notification = $.parseJSON(e.data);
        var html = Mustache.to_html(notification_template, notification);
        var hiding_html = $(html).show(0).delay(notification_timeout).hide(0);
        $("#notifications").children('ul').append(hiding_html);

        if (desktop_notifications_allowed) {
          var desktop_notification = notify.createNotification("Aurora notification",
            {
              body: notification.message,
              icon: {'x16': "{{ url_for('static', filename='aurora/img/favicon.ico') }}", 'x32': "{{ url_for('static', filename='aurora/img/favicon.png') }}"}
            }
          );

          setTimeout(function() { desktop_notification.close() }, notification_timeout);
        }
      }
    });
  </script>
{% endblock %}